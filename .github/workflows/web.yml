name: TDWeb

on:
  push:
    paths-ignore:
      - '*.md'

jobs:

  linux:
    name: Ubuntu 20.04
    runs-on: ubuntu-latest

    steps:
      - name: Clone
        uses: actions/checkout@v1

      - name: Installing dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install libssl-dev zlib1g-dev gperf -y

      - name: Install Emscripten
        shell: bash
        run: |
          git clone https://github.com/emscripten-core/emsdk.git
          cd emsdk
          ./emsdk install 1.39.5
          ./emsdk activate 1.39.5

      - name: Building OpenSSL
        shell: bash
        run: |
          source emsdk/emsdk_env.sh
          cd example/web
          ./build-openssl.sh

      - name: Building TDLib
        shell: bash
        run: |
          source emsdk/emsdk_env.sh
          cd example/web
          ./build-tdlib.sh

      - name: Moving TDLib files
        shell: bash
        run: |
          source emsdk/emsdk_env.sh
          cd example/web
          mkdir -p tdweb/src/prebuilt/release/
          mv build/wasm/td_wasm.js build/wasm/td_wasm.wasm tdweb/src/prebuilt/release/
          mv build/asmjs/td_asmjs.js build/asmjs/td_asmjs.js.mem tdweb/src/prebuilt/release/

      - name: Building TDWeb
        shell: bash
        run: |
          source emsdk/emsdk_env.sh
          cd example/web
          ./build-tdweb.sh

      - uses: actions/upload-artifact@master
        name: Upload artifact
        with:
          name: TDWeb
          path: example/web/tdweb/dist
